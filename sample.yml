apiVersion: iceberg/v1
spec:
  appName: ok
  listen: ":8081"
  configs:
    cors: 
      origin: ""
      methods: ""
      headersAllowed: ""
      headersExposed: "test"
      maxAge: ""
  resources:
    - name: freeze
      frontend: /
      backend: http://127.0.0.1:8080
      auth: 
        listener: "nats://[[default_nats]]/tests.a"
        timeout: 30
      cache: 
        repository: "nats://[[default_nats]]/bucket/30s"
        keyParams:
          path: "$1-$2"
          includeBody: false
      filterChains: 
        - name: payment-intent
          listener: "nats://[[default_nats]]/tests.a"
          level: "request"
          timeout: 30
          durable: true
          exchange: 
            headers: 
              - x-payment-token
          callbacks: 
            - name: generate-receipt
              listener: "nats://[[default_nats]]/tests.b"
              parallel: true
              durable: true
              timeout: 30
            - name: generate-receipt-2
              listener: "nats://[[default_nats]]/tests.c"
              parallel: true
              durable: true
              timeout: 30
            - name: generate-receipt-3
              listener: "nats://[[default_nats]]/tests.d"
              parallel: false
              durable: true
              timeout: 30              
              await: 
                - generate-receipt
                - generate-receipt-2